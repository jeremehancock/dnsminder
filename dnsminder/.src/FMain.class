' Gambas class file

Public Sub Form_Open()
  
  status_check()
  provider_check()
  
End

Function status_check() As Boolean
  
  Dim Result As String
  
  Result = get_provider()
  
  If InStr(Result, "185.228.168.168") = 1 Or If InStr(Result, "185.228.169.168") = 1 Or If InStr(Result, "208.67.222.123") = 1 Or If InStr(Result, "208.67.220.123") = 1 Or If InStr(Result, "1.1.1.3") = 1 Or If InStr(Result, "1.0.0.3") = 1 Or If InStr(Result, "94.140.14.15") = 1 Or If InStr(Result, "94.140.15.16") = 1 Then 
    ProvidersPanel.Enabled = True
    Status.Text = "ON"
    Status.Foreground = Color.DarkGreen
    OnButton.Show
    OffButton.Hide
  Else 
    ProvidersPanel.Enabled = False
    Status.Text = "OFF"
    Status.Foreground = Color.Red
    OnButton.Hide
    OffButton.Show
  Endif
  
End

Function get_provider() As String
  
  Dim Result As String
  
  Shell ("resolvectl status | grep 'Current DNS Server:' | awk '{print $4}'") To Result
  
  Return Result
  
End

Sub provider_check()
  
  Dim Result As String
  
  Result = get_provider()
  
  If InStr(Result, "185.228.168.168") = 1 Then 
    CleanBrowsing.Value = True
  Else 
    CleanBrowsing.Value = False
  Endif
  
  If InStr(Result, "185.228.169.168") = 1 Then 
    CleanBrowsing.Value = True
  Else 
    CleanBrowsing.Value = False
  Endif
  
  If InStr(Result, "208.67.222.123") = 1 Then 
    OpenDNS.Value = True
  Else 
    OpenDNS.Value = False
  Endif
  
  If InStr(Result, "208.67.220.123") = 1 Then 
    OpenDNS.Value = True
  Else 
    OpenDNS.Value = False
  Endif
  
  If InStr(Result, "1.1.1.3") = 1 Then 
    CloudFlare.Value = True
  Else 
    CloudFlare.Value = False
  Endif
  
  If InStr(Result, "1.0.0.3") = 1 Then 
    CloudFlare.Value = True
  Else 
    CloudFlare.Value = False
  Endif
  
  If InStr(Result, "94.140.14.15") = 1 Then 
    AdGuard.Value = True
  Else 
    AdGuard.Value = False
  Endif
  
  If InStr(Result, "94.140.15.16") = 1 Then 
    AdGuard.Value = True
  Else 
    AdGuard.Value = False
  Endif
  
End

Sub enable(provider As String, Optional providerTitle As String)
  
  Dim EnableProcess As Process
  
  Dim DNS1 As String
  Dim DNS2 As String
  
  Dim MessageString As String
  
  If provider = "CleanBrowsing" Then 
    DNS1 = "nameserver 185.228.168.168"
    DNS2 = "nameserver 185.228.169.168"
  Else If provider = "OpenDNS" Then 
    DNS1 = "nameserver 208.67.222.123"
    DNS2 = "nameserver 208.67.220.123"
  Else If provider = "CloudFlare" Then 
    DNS1 = "nameserver 1.1.1.3"
    DNS2 = "nameserver 1.0.0.3"
  Else If provider = "AdGuard" Then 
    DNS1 = "nameserver 94.140.14.15"
    DNS2 = "nameserver 94.140.15.16"
  Endif
  
  If providerTitle Then 
    MessageString = "\nAre you sure you want to enable " & providerTitle & "?"
  Else 
    MessageString = "\nAre you sure?"
  Endif
  
  If Message.Question(MessageString) = 1 Then 
    ProgressBar.Show
    ProvidersPanel.Enabled = False
    OffButton.Enabled = False
    EnableProcess = TerminalView.Shell("pkexec sh -c 'systemctl enable --now resolvconf.service && sed -i '/^nameserver/d' /etc/resolvconf/resolv.conf.d/head && echo " & DNS1 & " >> /etc/resolvconf/resolv.conf.d/head && echo " & DNS2 & " >> /etc/resolvconf/resolv.conf.d/head && resolvconf -u && nmcli networking off && nmcli networking on'")
    
    Do
      Try Wait 0.5    
    Loop Until EnableProcess.State = 0
    
    EnableProcess = Null
    
    status_check()
    provider_check()
    ProgressBar.Hide
    OnButton.Enabled = True
    
  Endif
  
End

Sub disable()
  
  Dim DisableProcess As Process
  
  If Message.Question("\nAre you sure?") = 1 Then 
    ProgressBar.Show
    ProvidersPanel.Enabled = False
    OnButton.Enabled = False
    DisableProcess = TerminalView.Shell("pkexec sh -c 'sed -i '/^nameserver/d' /etc/resolvconf/resolv.conf.d/head && resolvconf -u && systemctl disable --now resolvconf.service && nmcli networking off && nmcli networking on'")
    
    Do
      Try Wait 0.5    
    Loop Until DisableProcess.State = 0
    
    DisableProcess = Null
    
    status_check()
    provider_check()
    ProgressBar.Hide
    OffButton.Enabled = True
    
  Endif
  
End

Public Sub DisableButton_Click()
  
  disable()
  
End

Public Sub EnableButton_Click()
  
  enable("CleanBrowsing")
  
End

Public Sub CleanBrowsing_MouseDown()
  
  If CleanBrowsing.Value == False Then
    enable("CleanBrowsing", "CleanBrowsing")
  Endif
  
End

Public Sub OpenDNS_MouseDown()
  
  If OpenDNS.Value == False Then
    enable("OpenDNS", "OpenDNS FamilyShield")
  Endif
  
End

Public Sub CloudFlare_MouseDown()
  
  If CloudFlare.Value == False Then
    enable("CloudFlare", "1.1.1.1. for Families")
  Endif
  
End

Public Sub AdGuard_MouseDown()
  
  If AdGuard.Value == False Then
    enable("AdGuard", "AdGuard Family DNS")
  Endif
  
End

Public Sub LearnMore_Click()
  
  Shell "xdg-open 'https://github.com/jeremehancock/dnsminder'"
  
End

Public Sub CleanBrowsingInfo_MouseDown()
  
  Shell "xdg-open 'https://cleanbrowsing.org/'"
  
End

Public Sub CleanBrowsingInfo2_MouseDown()
  
  Shell "xdg-open 'https://www.opendns.com/setupguide/#familyshield'"
  
End

Public Sub CleanBrowsingInfo3_MouseDown()
  
  Shell "xdg-open 'https://blog.cloudflare.com/introducing-1-1-1-1-for-families/'"
  
End

Public Sub CleanBrowsingInfo4_MouseDown()
  
  Shell "xdg-open 'https://adguard-dns.io/en/public-dns.html'"
  
End

Public Sub OffButton_MouseDown()
  
  enable("CleanBrowsing")
  OnButton.Show
  OffButton.Hide
  
End

Public Sub OnButton_MouseDown()
  
  disable()
  OffButton.Show
  OnButton.Hide
  
End
